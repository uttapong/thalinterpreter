/*
 * Copyright (C) 2015 Thalassemia Interpreter Software
 *
 * This file is part of the Thalassemia Interpreter Software project.
 *
 * Unauthorized copying of this file, via any medium is strictly prohibited
 *
 * Thalassemia Interpreter Software project can not be copied and/or distributed without the express
 * permission of National Science and Technology Development Agency,111 Thailand Science Park (TSP),
 * Phahonyothin Road, Khlong Nueng, Khlong Luang, Pathum Thani 12120, Thailand
 */
exports.numtidy=function(value){
	//value=value.trim();
	console.log(value);
	if(value && value.toString().toLowerCase()=='found')return 1;
	else if(isNaN(value)||value==null||value=='')return 0;
	else return parseFloat(value);
}
exports.interprete = function(req,type) {

	if(type==='live')data=req.body;
	else if(type==='single') data=req.typing;
	else if(type==='batch')data=req.typing;

	data.hbe=data.hbe || 0;
	data.a2=data.a2 || 0;
	data.a2e=data.a2e || 0;
	data.hbcs=data.hbcs || 0;
	data.a=data.a || 0;
	data.f=data.f || 0;
	data.hbe=data.hbe || 0;
	data.bart=data.bart || 0;
	data.h=data.h || 0;
	data.mcv=data.mcv || 0;
	data.mch=data.mch || 0;
	data.bart_h=data.bart_h||0;	

	data.hbe=parseFloat(data.hbe);
	data.a2=parseFloat(data.a2);
	data.a2e=parseFloat(data.a2e);
	data.hbcs=parseFloat(data.hbcs);
	data.a=parseFloat(data.a);
	data.f=parseFloat(data.f);
	data.hbe=parseFloat(data.hbe);
	data.bart=parseFloat(data.bart);
	data.h=parseFloat(data.h);
	data.mcv=parseFloat(data.mcv);
	data.mch=parseFloat(data.mch);
	data.bart_h=parseFloat(data.bart_h);

	if(data.hbcs&&(data.hbcs.toString().toLowerCase()=='found'||data.hbcs.toString().toLowerCase()=='f'))data.hbcs=1;
	if(data.bart&&(data.bart.toString().toLowerCase()=='found'||data.bart.toString().toLowerCase()=='f'))data.bart=1;
	if(data.h&&(data.h.toString().toLowerCase()=='found'||data.h.toString().toLowerCase()=='f'))data.h=1;
	if(data.bart_h&&(data.bart_h.toString().toLowerCase()=='found'||data.bart_h.toString().toLowerCase()=='f'))data.bart_h=1;

	if(!data.bart_h || data.bart_h<=0)data.bart_h=data.bart+data.h;


	if(data.hbe+data.a2+data.a2e+data.hbcs+data.a+data.f+data.hbe+data.bart+data.h+data.mcv+data.mch <=0)return;

	if(data.a2e!==0){
	//	data.a2=data.a2e;
	//	data.hbe=data.a2e;
	}
	else{
		var a2e=parseFloat(data.a2)+parseFloat(data.hbe);
		data.a2e=a2e;
	//	data.a2=a2e;
	//	data.hbe=a2e;
	}

	console.log(data);
//	var isMCH=data.mch&&data.mch!==''&&data.mch!=='-'&&data.mch!==0;
//	console.log("isMCh : "+isMCH)
//check for CE Machine
	//if(data.a2!=0 && data.a2e!=0){
//	var livedata={dcip:parseFloat(req.dcip)||0, hb:parseFloat(req.hb)||0, a:parseFloat(req.a)||0, a2:req.a2||0, f:parseFloat(req.f)||0, hbe:parseFloat(req.hbe)||0, hbcs:parseFloat(req.hbcs)||0, bart_h:parseFloat(req.bart_h)||0, mcv:parseFloat(req.mcv||0)};
//	var liveresult={};
	var result_obj={};
	var boundary=[];
	var result='NA';

		//var a2e=parseFloat(data.a2)+parseFloat(data.a2e);
		//data.a2=a2e;
	//	data.a2e=a2e;


	//}
	console.log('start rule----------------------');
	/*if(data.f>60){
		console.log('possilbe Fetal');
		if(data.a2e==0&&data.hbcs==0)result= 'HOMO_BETA_THAL';
		if(data.a2e==0&&data.hbcs==0&&data.bart_h>=10)result= 'FETUS_WITH_ALPHA_THAL';
		if(data.a2e==0&&data.hbcs==0&&data.bart_h<10)result= 'NORMAL_FETAL';

		if(data.a2e>0&&data.hbcs==0)result= 'FETUS_WITH_BETA_THAL_E';
		if(data.a2e>0&&data.hbcs==0&&data.bart_h>=10)result= 'FETUS_WITH_HBE_ALPHA_THAL';
		if(data.a2e>0&&data.hbcs==0&&data.bart_h<10)result= 'FETUS_WITH_HB_E';

		if(data.a2e>0&&data.hbcs>0&&data.bart_h>=10) result= 'FETUS_WITH_HBE_CS';

	}
	else{*/

		if(suspect(data.a2e,3.5))boundary.push('a2');
		if(data.a2e<=3.5){
			console.log('-----------------------------------Possible Alpha thal');
			if(data.bart_h>0){
				if(data.hbcs>0){

					if(data.mcv>=80||data.mch>20){ result= 'HB_HOMO_CS';}
					else{ result= 'HB_H_CS'; }

					if(suspect(data.mcv,80))boundary.push('mcv');
				}
				else if(data.hbcs<=0){

					if(data.mcv<80 || data.mch<25)result= 'HB_H';
					else result='FAIL_HB_H';

					if(suspect(data.mcv,80))boundary.push('mcv');
					if(suspect(data.mch,25))boundary.push('mch');
				}

			}
			else if(data.bart_h<=0){
				//console.log('in here 3----------------------');
				if(data.hbcs>0){


				 if(data.mcv>75 || data.mch>20)result= 'HB_HOMO_CS';else result= 'HB_CS';

					if(suspect(data.mcv,75))boundary.push('mcv');
					if(suspect(data.mch,20))boundary.push('mch');

				}
				else if(data.hbcs<=0){
					if(suspect(data.mcv,75))boundary.push('mcv');
					if(suspect(data.mcv,85))boundary.push('mcv');
					if(suspect(data.mch,25))boundary.push('mch');

					if(data.mcv<75 || data.mch<25){ result= 'ALPHA_THAL1_TRAIT';if(suspect(data.mcv,75))boundary.push('mcv');}
					else if(data.mcv>=75 && data.mcv<85){ result= 'ALPHA_THAL_2';if(suspect(data.mcv,75))boundary.push('mcv');}
					else if(data.mcv>=85 || data.mch>=25){ result= 'NORMAL_HB';}
					
						//if(data.mcv>=75)result= 'ALPHA_THAL_2';

				}
			}

		}

		if(data.a2e>3.5){
			if(suspect(data.a2e,8))boundary.push('a2');
			if(data.a2e<8){
		//	console.log('-----------------------------------Possible Beta thal');
				if(data.a2e<4){
					if(suspect(data.a2e,4))boundary.push('a2');
					if(suspect(data.mcv,75))boundary.push('mcv');
					if(suspect(data.mcv,85))boundary.push('mcv');
					if(suspect(data.mch,25))boundary.push('mcv');

					if(data.mcv<75 || data.mch<25)result= 'BETA_THAL';
					else{
						if(data.mcv<75 || data.mch<25){ result= 'ALPHA_THAL1_TRAIT';}
						else if(data.mcv>=75 && data.mcv<85){ result= 'ALPHA_THAL_2';}
						else if(data.mcv>=85 || data.mch>=25){ result= 'NORMAL_HB';}
					}
					//else result='FAIL_BETA_THAL_TRAIT';
				}
				else{
					if(suspect(data.mcv,75))boundary.push('mcv');
					if(suspect(data.mch,25))boundary.push('mcv');
					if((data.mcv<75||data.mch<25)&&data.f<10)result='BETA_THAL';
					else result='HOMO_BETA_THAL';
				}
				

				

			}
			else if(data.a2e>=8){

				if(data.bart_h>0){
					if(suspect(data.a2e,75))boundary.push('hbe');

					if(data.hbcs>0){
						if(data.a2e>75)result= 'EF_BART_CS';
						else result= 'AE_BART_CS';
					}
					else if(data.hbcs<=0){
						if(data.a2e>75)result= 'EF_BART';
						else result= 'AE_BART';
					}
				}
				else if(data.bart_h<=0){
				//	console.log(data);
					if(suspect(data.f,10))boundary.push('f');

					if(data.f>=10)result='BETA_THAL_HBE';
					else{
						if(suspect(data.a2e,35))boundary.push('hbe');
						if(suspect(data.a2e,25))boundary.push('hbe');

						if(data.a2e>35){

							if(suspect(data.a2e,70))boundary.push('hbe');
							if(data.a2e>70)result= 'HBE_HOMO';
							else result= 'BETA_THAL_HBE';
						}
						else if(data.a2e<=25){

							if(suspect(data.mch,25))boundary.push('mch');
							if(suspect(data.mcv,70))boundary.push('mcv');
							if(suspect(data.a2e,25))boundary.push('hbe');

							if(data.a2e>=25){
								result= 'HBE_WITH_ALPHA_THAL2';
							}
							else if(data.a2e<25&&(data.mcv<=70 || (data.mch <25 && data.mch>0))){
								result= 'HBE_WITH_ALPHA_THAL1';
								
							}
							else{
								result= 'HBE_WITH_ALPHA_THAL2';
							}

						}
					}
				}
			}
		}
	//}//else after check for f 
	console.log(result);
	result_obj.result=result;
	boundary=boundary.filter( onlyUnique );
	result_obj.boundary=boundary;
	return result_obj;
};

function suspect(value,cutoff){
	var sd=0;
	if(value<=10)sd=1;
	else sd=2;

	if(value>=(cutoff-sd)&&value<=(cutoff+sd))return true;
	return false;
}

function onlyUnique(value, index, self) {
    return self.indexOf(value) === index;
}


