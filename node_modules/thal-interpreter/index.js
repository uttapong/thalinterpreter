/*
 * Copyright (C) 2015 Thalassemia Interpreter Software
 *
 * This file is part of the Thalassemia Interpreter Software project.
 *
 * Unauthorized copying of this file, via any medium is strictly prohibited
 *
 * Thalassemia Interpreter Software project can not be copied and/or distributed without the express
 * permission of National Science and Technology Development Agency,111 Thailand Science Park (TSP),
 * Phahonyothin Road, Khlong Nueng, Khlong Luang, Pathum Thani 12120, Thailand
 */
exports.numtidy=function(value){
	//value=value.trim();
	console.log(value);
	if(value.toString().toLowerCase()=='found')return 1;
	else if(isNaN(value)||value==null||value=='')return 0;
	else return parseFloat(value);
}
exports.interprete = function(req,type) {

	if(type==='live')data=req.body;
	else if(type==='single') data=req.typing;
	else if(type==='batch')data=req.typing;





	data.hbe=data.hbe || 0;
	data.a2=data.a2 || 0;
	data.a2e=data.a2e || 0;
	data.hbcs=data.hbcs || 0;
	data.a=data.a || 0;
	data.f=data.f || 0;
	data.hbe=data.hbe || 0;
	data.bart_h=data.bart_h || 0;
	data.mcv=data.mcv || 0;
	data.mch=data.mch || 0;

	if(data.hbcs&&(data.hbcs.toString().toLowerCase()=='found'||data.hbcs.toString().toLowerCase()=='f'))data.hbcs=1;
	if(data.bart_h&&(data.bart_h.toString().toLowerCase()=='found'||data.bart_h.toString().toLowerCase()=='f'))data.bart_h=1;

	if(data.hbe+data.a2+data.a2e+data.hbcs+data.a+data.f+data.hbe+data.bart_h+data.mcv+data.mch <=0)return;

	if(data.a2e!==0){
		data.a2=data.a2e;
		data.hbe=data.a2e;
	}
	else{
		var a2e=parseFloat(data.a2)+parseFloat(data.hbe);
		data.a2=a2e;
		data.hbe=a2e;
	}


	console.log(data);
//	var isMCH=data.mch&&data.mch!==''&&data.mch!=='-'&&data.mch!==0;
//	console.log("isMCh : "+isMCH)
//check for CE Machine
	//if(data.a2!=0 && data.hbe!=0){
//	var livedata={dcip:parseFloat(req.dcip)||0, hb:parseFloat(req.hb)||0, a:parseFloat(req.a)||0, a2:req.a2||0, f:parseFloat(req.f)||0, hbe:parseFloat(req.hbe)||0, hbcs:parseFloat(req.hbcs)||0, bart_h:parseFloat(req.bart_h)||0, mcv:parseFloat(req.mcv||0)};
//	var liveresult={};
	var result_obj={};
	var boundary=[];
	var result='NA';

		//var a2e=parseFloat(data.a2)+parseFloat(data.hbe);
		//data.a2=a2e;
	//	data.hbe=a2e;


	//}
	console.log('start rule----------------------');
	if(data.f>60){
		console.log('possilbe Fetal');
		if(data.hbe==0&&data.hbcs==0)result= 'HOMO_BETA_THAL';
		if(data.hbe==0&&data.hbcs==0&&data.bart_h>=10)result= 'FETUS_WITH_ALPHA_THAL';
		if(data.hbe==0&&data.hbcs==0&&data.bart_h<10)result= 'NORMAL_FETAL';

		if(data.hbe>0&&data.hbcs==0)result= 'FETUS_WITH_BETA_THAL_E';
		if(data.hbe>0&&data.hbcs==0&&data.bart_h>=10)result= 'FETUS_WITH_HBE_ALPHA_THAL';
		if(data.hbe>0&&data.hbcs==0&&data.bart_h<10)result= 'FETUS_WITH_HB_E';

		if(data.hbe>0&&data.hbcs>0&&data.bart_h>=10) result= 'FETUS_WITH_HBE_CS';

	}
	else{

		if(suspect(data.a2,3.5))boundary.push('a2');
		if(data.a2<=3.5){
			console.log('-----------------------------------Possible Alpha thal');
			if(data.bart_h>0){
				if(data.hbcs>0){

					if(data.mcv>=80){ result= 'HB_HOMO_CS';}
					else{ result= 'HB_H_CS'; }

					if(suspect(data.mcv,80))boundary.push('mcv');
				}
				else if(data.hbcs<=0){

					if(data.mcv<80 || data.mch<25)result= 'HB_H';
					else result='FAIL_HB_H';

					if(suspect(data.mcv,80))boundary.push('mcv');
					if(suspect(data.mch,25))boundary.push('mch');
				}

			}
			else if(data.bart_h<=0){
				//console.log('in here 3----------------------');
				if(data.hbcs>0){


				 if(data.mcv>75 || data.mch>20)result= 'HB_HOMO_CS';else result= 'HB_CS';

					if(suspect(data.mcv,75))boundary.push('mcv');
					if(suspect(data.mch,20))boundary.push('mch');

				}
				else if(data.hbcs<=0){

					if(suspect(data.mcv,85))boundary.push('mcv');
					if(suspect(data.mch,25))boundary.push('mch');

					if(data.mcv>=85 || data.mch>=25){ result= 'NORMAL_HB';}
					else if(data.mcv<75 || data.mch<25){ result= 'ALPHA_THAL1_TRAIT';if(suspect(data.mcv,75))boundary.push('mcv');}

					/**** suspicious****/

					if(data.mcv>=75 && data.mcv<85){ result= 'ALPHA_THAL_2';if(suspect(data.mcv,75))boundary.push('mcv');}

						//if(data.mcv>=75)result= 'ALPHA_THAL_2';

				}
			}

		}

		if(data.a2>3.5){
			if(suspect(data.a2,8))boundary.push('a2');
			if(data.a2<8){
		//	console.log('-----------------------------------Possible Beta thal');
				if(suspect(data.mcv,75))boundary.push('mcv');

				if(data.a2<8&&(data.mcv<75 || data.mch<25))result= 'BETA_THAL';
				else result='FAIL_BETA_THAL_TRAIT';

			}
			if(data.a2>=8){

				if(data.bart_h>0){
					if(suspect(data.hbe,75))boundary.push('hbe');

					if(data.hbcs>0){
						if(data.hbe>75)result= 'EF_BART_CS';
						else result= 'AE_BART_CS';
					}
					else if(data.hbcs<=0){
						if(data.hbe>75)result= 'EF_BART';
						else result= 'AE_BART';
					}
				}
				else if(data.bart_h<=0){
				//	console.log(data);
					if(suspect(data.hbe,35))boundary.push('hbe');
					if(data.hbe>35){

						if(suspect(data.hbe,75))boundary.push('hbe');
						if(data.hbe>75)result= 'HBE_HOMO';
						else result= 'BETA_THAL_HBE';
					}
					else if(data.hbe<=35){

						if(suspect(data.mch,25))boundary.push('mch');
						if(suspect(data.mcv,70))boundary.push('mcv');


						if(data.hbe<25&&(data.mcv<=70 || (data.mch <25 && data.mch>0))){
							result= 'HBE_WITH_ALPHA_THAL1';
							if(suspect(data.hbe,25))boundary.push('hbe');
						}
						else if((data.hbe>20&&data.hbe<=35)&&(data.mcv>70 || data.mch>=25)){
							result= 'HBE_TRAIT';
							if(suspect(data.hbe,20))boundary.push('hbe');
						}
						else {
							result= 'FAIL_HBE';
							if(suspect(data.hbe,20))boundary.push('hbe');
							if(suspect(data.hbe,25))boundary.push('hbe');
						}

					}
				}
			}
		}
	}//else after check for f
	console.log(result);
	result_obj.result=result;
	boundary=boundary.filter( onlyUnique );
	result_obj.boundary=boundary;
	return result_obj;
};

function suspect(value,cutoff){
	var sd=0;
	if(value<=10)sd=1;
	else sd=2;

	if(value>=(cutoff-sd)&&value<=(cutoff+sd))return true;
	return false;
}

function onlyUnique(value, index, self) {
    return self.indexOf(value) === index;
}

exports.liveinterprete = function(reqdata) {
var req=reqdata.body;
console.log(req.a2);
var data={dcip:parseFloat(req.dcip)||0, hb:parseFloat(req.hb)||0, a:parseFloat(req.a)||0, a2:req.a2||0, f:parseFloat(req.f)||0, hbe:parseFloat(req.hbe)||0, hbcs:parseFloat(req.hbcs)||0, bart_h:parseFloat(req.bart_h)||0, mcv:parseFloat(req.mcv||0)};
var result={};
		var a2e=parseFloat(data.a2)+parseFloat(data.hbe);
		data.a2=a2e;
		data.hbe=a2e;
	//}
	//console.log('in here 1----------------------');

	if(data.f>60&&data.hbe==0&&data.hbcs==0)result.HOMO_BETA_THAL=1 ;else result.HOMO_BETA_THAL=0;
	if(data.f>60&&data.hbe==0&&data.hbcs==0&&data.bart_h>=10)result.FETUS_WITH_ALPHA_THAL=1; else result.FETUS_WITH_ALPHA_THAL=0;
	if(data.f>60&&data.hbe==0&&data.hbcs==0&&data.bart_h<10)result.NORMAL_FETAL=1;else result.NORMAL_FETAL=0;

	if(data.f>60&&data.hbe>0&&data.hbcs==0)result.FETUS_WITH_BETA_THAL_E=1;else result.FETUS_WITH_BETA_THAL_E=0;
	if(data.f>60&&data.hbe>0&&data.hbcs==0&&data.bart_h>=10)result.FETUS_WITH_HBE_ALPHA_THAL=1;else result.FETUS_WITH_HBE_ALPHA_THAL=0;
	if(data.f>60&&data.hbe>0&&data.hbcs==0&&data.bart_h<10)result.FETUS_WITH_HB_E=1;else result.FETUS_WITH_HB_E=0;

	if(data.f>60&&data.hbe>0&&data.hbcs>0&&data.bart_h>=10) result.FETUS_WITH_HBE_CS=1;else result.FETUS_WITH_HBE_CS=0;


	//a2 <=3.5
	if(data.a2<=3.5&&data.hbcs>0&&(data.bart_h>0&&data.mcv>80)||(data.bart_h<=0&&data.mcv>75))result.HB_HOMO_CS=1;else  result.HB_HOMO_CS=0;
	if(data.a2<=3.5&&data.bart_h>0&&data.hbcs>0&&data.mcv<=80)result.HB_H_CS=1;else  result.HB_H_CS=0;
	if(data.a2<=3.5&&data.bart_h>0&&data.hbcs<=0&&data.mcv<80)result.HB_H=1;else  result.HB_H=0;

	//if(data.a2<=3.5&&result.HB_HOMO_CS=1;else  result.HB_HOMO_CS=0;
	if(data.a2<=3.5&&data.bart_h<=0&&data.hbcs>0&&data.mcv<=75)result.HB_CS=1;else  result.HB_CS=0;

	if(data.a2<=3.5&&data.bart_h<=0&&data.hbcs<=0&&data.mcv>=85)result.NORMAL_HB=1;else  result.NORMAL_HB=0;
	if(data.a2<=3.5&&data.bart_h<=0&&data.hbcs<=0&&data.mcv<75)result.ALPHA_THAL1_TRAIT=1;else  result.ALPHA_THAL1_TRAIT=0;
	if(data.a2<=3.5&&data.bart_h<=0&&data.hbcs<=0&&data.mcv>=75)result.ALPHA_THAL_2=1;else  result.ALPHA_THAL_2=0;

	//a2 >3.5

	if(data.a2>3.5&&data.a2<8&&data.mcv<75)result.BETA_THAL=1;else  result.BETA_THAL=0;

	if(data.a2>=8&&data.bart_h>0&&data.hbcs>0&&data.hbe>75)result.EF_BART_CS=1;else  result.EF_BART_CS=0;
	if(data.a2>=8&&data.bart_h>0&&data.hbcs>0&&data.hbe<=75) result.AE_BART_CS=1;else  result.AE_BART_CS=0;

	if(data.a2>=8&&data.bart_h>0&&data.hbcs<=0&&data.hbe>75)result.EF_BART=1;else  result.EF_BART=0;
	if(data.a2>=8&&data.bart_h>0&&data.hbcs<=0&&data.hbe<=75) result.AE_BART=1;else  result.AE_BART=0;


	if(data.a2>=8&&data.bart_h<=0&&data.hbe>35&&data.hbe>75)result.HBE_HOMO=1;else  result.HBE_HOMO=0;
	if(data.a2>=8&&data.bart_h<=0&&data.hbe>35&&data.hbe<=75) result.BETA_THAL_HBE=1;else  result.BETA_THAL_HBE=0;

	if(data.a2>=8&&data.bart_h<=0&&data.hbe<=35&&(data.hbe<25||data.mcv<70))result.HBE_WITH_ALPHA_THAL1=1;else  result.HBE_WITH_ALPHA_THAL1=0;
	if(data.a2>=8&&data.bart_h<=0&&data.hbe<=35&&((data.hbe>20&&data.hbe<=35)||data.mcv>70))result.HBE_TRAIT=1;else  result.HBE_TRAIT=0;
	console.log(data);
	return result;


};
